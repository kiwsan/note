sudo: required
language: node_js
node_js:
  - stable
services:
  - docker
addons:
  ssh_known_hosts: "${SSH_HOST}"
before_script:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
install:
  - npm install -g gatsby-cli
  - npm install
script:
  - gatsby build
  - cd public
  - cp index.html 404.html
  - cd ..
  - docker-compose -f docker-compose.yml build
  - docker tag noted $DOCKERHUB_NOTED
  - docker push $DOCKERHUB_NOTED
after_script:
  - rm -rf .git
  - eval "$(ssh-agent -s)" && ssh-add ~/.ssh/travis_rsa && ssh -o "StrictHostKeyChecking=no" ${REMOTE_USER}@${SSH_HOST} -v exit
deploy:
  provider: pages
  skip_cleanup: true
  github_token: "$GITHUB_TOKEN"
  local_dir: public
  on:
    branch: master
before_install:
  - openssl aes-256-cbc -K $encrypted_58ca57a8e487_key -iv $encrypted_58ca57a8e487_iv
    -in travis_rsa.enc -out travis_rsa -d
