sudo: required
language: node_js
node_js:
  - "stable"

services:
  - docker

before_script:
  # login docker hub
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

install:
  - npm install -g gatsby-cli
  - npm install

script:
  - gatsby build
  - cp docker-compose.yml public/docker-compose.yml
  - cd public
  - cp index.html 404.html  
  # build docker images
  - docker-compose -f docker-compose.yml build
  - docker tag noted $DOCKERHUB_NOTED

after_script:
  # push to docker hub
  - docker push $DOCKERHUB_NOTED

deploy:
  provider: pages
  skip_cleanup: true
  github_token: $GITHUB_TOKEN
  local_dir: public
  on:
    branch: master
